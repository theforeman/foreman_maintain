class Features::IopVulnerabilityDatabase < ForemanMaintain::Feature
  include ForemanMaintain::Concerns::BaseDatabase

  metadata do
    label :iop_vulnerability_database

    confine do
      File.exist?('/etc/containers/networks/iop-core-network.json') ||
        File.exist?('/etc/containers/systemd/iop-core.network')
    end
  end

  def configuration
    @configuration || load_configuration
  end

  def services
    [
      system_service('postgresql', 10, :component => 'iop',
        :db_feature => feature(:iop_vulnerability_database)),
    ]
  end

  private

  # rubocop:disable Metrics/MethodLength
  def load_configuration
    podman_command = "podman exec iop-service-vuln-manager bash -c 'env |grep POSTGRES_'"
    podman_result = begin
      execute!(podman_command, merge_stderr: false).lines.map do |l|
        l.strip.split('=')
      end.to_h
    rescue ForemanMaintain::Error::ExecutionError
      {}
    end

    db_host = if podman_result['POSTGRES_HOST'].nil? ||
                 podman_result['POSTGRES_HOST'].start_with?('/var/run/postgresql')
                'localhost'
              else
                podman_result['POSTGRES_HOST']
              end
    @configuration = {
      'host' => db_host,
      'port' => podman_result['POSTGRES_PORT'],
      'database' => podman_result['POSTGRES_DB'],
      'password' => podman_result['POSTGRES_PASSWORD'],
      'username' => podman_result['POSTGRES_USER'],
    }
  end
  # rubocop:enable Metrics/MethodLength
end
